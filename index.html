<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Carte – fr176 (mers 22 → 77)</title>
<style>
/* ─── mise en page ─────────────────────────── */
body{margin:0;background:#111;color:#ccc;font-family:sans-serif;
     display:flex;flex-direction:column;align-items:center}
#topbar{margin-top:12px;display:flex;gap:24px;flex-wrap:wrap}
.bar{display:flex;align-items:center;gap:6px}
.groupBar{display:flex;align-items:center;gap:14px}
select,button{padding:4px;font-size:14px}
input[type=color]{border:none;width:22px;height:22px;padding:0}

/* ─── zone carte ───────────────────────────── */
#mapWrapper{position:relative;margin-top:12px}
canvas{border:2px solid #444}

/* ─── légende ──────────────────────────────── */
#legend{position:fixed;top:10px;left:10px;display:flex;flex-direction:column;gap:4px;font-size:14px}
.row{display:flex;align-items:center;gap:4px}
.row input[type=checkbox]{margin:0}

/* ─── temples ─────────────────────────────── */
.templeIcon{position:absolute;left:0;top:0;width:24px;height:24px;
            transform:translate(-12px,-12px);pointer-events:auto;}
.templeIcon::before{content:"";position:absolute;inset:0;border-radius:50%;
  transform:translate(-2px,-1px) scale(1.25);opacity:.2;z-index:0;background:transparent;}
.templeIcon.secured::before    {background:#00c853;}
.templeIcon.tocomplete::before {background:#ffeb3b;}
.templeIcon.contested::before  {background:#ff1744;}
.templeIcon.none::before       {display:none;}

.sprite{position:relative;width:100%;height:100%;z-index:1;
        background:url(https://gpfr.innogamescdn.com/images/game/autogenerated/map/general/map_general_24f9f8c.png) no-repeat;}
.sprite.small{background-position:-108px -51px;}
.sprite.large{background-position:-84px  -51px;}
.sprite.olympus{background-position:-60px -51px;}

/* filtres de teinte (appliqués SEULEMENT si classe ajoutée) */
.sprite.red   {filter:hue-rotate(-60deg)saturate(8) brightness(1.25) contrast(1.1);}
.sprite.green {filter:hue-rotate( 90deg)saturate(4);}
.sprite.blue  {filter:hue-rotate(200deg)saturate(4);}
.sprite.yellow{filter:hue-rotate(-30deg)saturate(5)brightness(1.2);}
.sprite.violet{filter:hue-rotate(260deg)saturate(4);}
.sprite.black {filter:brightness(0)  saturate(0);}
.sprite.white {filter:brightness(3)  saturate(0);}
</style>
</head>
<body>

<div id="topbar">
  <div class="bar">
    Joueur : <select id="playerSel"></select>
    <button id="addPlayer">＋</button>
  </div>

  <div class="bar">
    Alliance : <select id="allySel"></select>
    <button id="addAlly">＋</button>
  </div>

  <div class="groupBar">
    <label><input type="checkbox" id="chkMolky"> Molky</label>
    <label><input type="checkbox" id="chkAllies"> Alliés</label>
    <label><input type="checkbox" id="chkCafe"> Café clopes</label>
    <label><input type="checkbox" id="chkContest"> Contest</label>
    <label><input type="checkbox" id="chkColor"> Colorer temples</label>
  </div>
</div>

<div id="legend"></div>
<div id="mapWrapper"><canvas id="map" width="800" height="800"></canvas></div>

<script src="mapData.js"></script>
<script>
/* ─── constantes carte ─── */
const VIEW=6,CELL=100,SIZE=800,SCALE=SIZE/(VIEW*CELL);
const BX=2,BY=2,X_MIN=BX*CELL,Y_MIN=BY*CELL,X_MAX=X_MIN+VIEW*CELL,Y_MAX=Y_MIN+VIEW*CELL;

/* groupes fixes */
const GROUPS={
  molky :{ids:[186,368],color:'#ff0000'},
  allies:{ids:[335,19,239],color:'#0099FF'},   // ← alliés en bleu clair
  cafe  :{ids:[3,350],   color:'#ff8c00'}
};

/* palettes et états */
const palette=['#00ffff','#ff7f00','#00ff00','#ff00ff','#ffff00','#00bfff',
               '#ff1493','#7fff00','#ff4500','#20b2aa'];
let palIdx=0;
const visA={},colA={},visP={},colP={};

/* DOM refs */
const mapWrapper=document.getElementById('mapWrapper');
const canvas=document.getElementById('map'),ctx=canvas.getContext('2d');
const playerSel=document.getElementById('playerSel'),addPlayer=document.getElementById('addPlayer');
const allySel=document.getElementById('allySel'),addAlly=document.getElementById('addAlly');
const legend=document.getElementById('legend');
const chkMolky=document.getElementById('chkMolky');
const chkAllies=document.getElementById('chkAllies');
const chkCafe=document.getElementById('chkCafe');
const chkContest=document.getElementById('chkContest');
const chkColor=document.getElementById('chkColor');

/* listes déroulantes */
mapData.players.slice().sort((a,b)=>a.name.localeCompare(b.name,'fr'))
  .forEach(p=>playerSel.add(new Option(p.name,p.id)));
mapData.alliances.slice().sort((a,b)=>a.name.localeCompare(b.name,'fr'))
  .forEach(a=>allySel.add(new Option(a.name,a.id)));

/* légende dynamique */
function addRow(id,label,color,vis,col){
  if(vis[id])return;
  vis[id]=true;col[id]=color;
  const row=document.createElement('div');row.className='row';row.dataset.aid=id;
  const cb=document.createElement('input');cb.type='checkbox';cb.checked=true;
  cb.onchange=()=>{vis[id]=cb.checked;draw();};
  const cp=document.createElement('input');cp.type='color';cp.value=color;
  cp.oninput=()=>{col[id]=cp.value;draw();};
  row.append(cb,cp,document.createTextNode(label));
  legend.append(row);
}
function removeRow(id,vis){
  const row=legend.querySelector(`.row[data-aid="${id}"]`);
  if(row)legend.removeChild(row);delete vis[id];
}

/* boutons */
addPlayer.onclick=()=>{
  const p=mapData.players.find(x=>x.id==playerSel.value);
  if(p)addRow(p.id,p.name,palette[palIdx++%palette.length],visP,colP),draw();
};
addAlly.onclick=()=>{
  const a=mapData.alliances.find(x=>x.id==allySel.value);
  if(a)addRow(a.id,a.name,palette[palIdx++%palette.length],visA,colA),draw();
};
/* groupes */
function toggleGroup(box,g){
  g.ids.forEach(id=>{
    box.checked
      ? addRow(id,mapData.alliances.find(a=>a.id==id)?.name||`Alliance ${id}`,g.color,visA,colA)
      : removeRow(id,visA);
  });
  draw();
}
chkMolky.onchange  =()=>toggleGroup(chkMolky ,GROUPS.molky );
chkAllies.onchange =()=>toggleGroup(chkAllies,GROUPS.allies);
chkCafe.onchange   =()=>toggleGroup(chkCafe  ,GROUPS.cafe  );
chkContest.onchange=draw;
chkColor.onchange  =draw;

/* offsets mini */
const OFF=[[0,0],[1,0],[-1,0],[0,1],[0,-1],
           [1,1],[-1,1],[1,-1],[-1,-1],
           [2,0],[-2,0],[0,2],[0,-2],
           [2,1],[2,-1],[-2,1],[-2,-1],
           [1,2],[-1,2],[1,-2]];
const toPx=(c,o)=>(c-o)*SCALE;
function dot(t,r){
  const d=OFF[t.slot%20]||[0,0];
  ctx.beginPath();
  ctx.arc(toPx(t.x+d[0],X_MIN),toPx(t.y+d[1],Y_MIN),r,0,Math.PI*2);
  ctx.fill();
}

/* temples */
const COLOR_BY_TYPE={
  'OFF T':'yellow','OFF NAV':'red','PROD T':'green','PROD NAV':'blue',
  'DEF':'black','3% OFF':'violet','Portail':'white'
};
function drawTemples(){
  mapWrapper.querySelectorAll('.templeIcon').forEach(e=>e.remove());
  if(!Array.isArray(mapData.temples))return;

  const showContest = chkContest.checked;
  const showColor   = chkColor.checked;

  mapData.temples.forEach(t=>{
    if(t.x<X_MIN||t.x>=X_MAX||t.y<Y_MIN||t.y>=Y_MAX)return;

    const status=(showContest && t.contest && t.contest!=='none') ? t.contest : 'none';

    const box=document.createElement('div');
    box.className=`templeIcon ${status}`.trim();
    box.style.left=`${toPx(t.x,X_MIN)}px`;
    box.style.top =`${toPx(t.y,Y_MIN)}px`;
    box.title=`${t.name}\n${t.bonus}`;

    const sp=document.createElement('div');
    sp.className=`sprite ${t.size||'small'}`;
    const colClass=COLOR_BY_TYPE[t.type];
    if(showColor && colClass) sp.classList.add(colClass);

    box.append(sp);
    mapWrapper.append(box);
  });
}

/* fond mer */
const water=new Image();
water.src='assets/water_base.png';
water.onload=draw;water.onerror=draw;

/* rendu principal */
function draw(){
  ctx.fillStyle=water.complete&&water.naturalWidth
    ? ctx.createPattern(water,'repeat')
    : '#0a4c82';
  ctx.fillRect(0,0,SIZE,SIZE);

  /* villes – rayons +50 % (alliances 1.5 px, joueurs 1.95 px) */
  mapData.alliances.forEach(a=>{
    if(!visA[a.id])return;
    ctx.fillStyle=colA[a.id];
    a.towns.forEach(t=>{
      if(t.x>=X_MIN&&t.x<X_MAX&&t.y>=Y_MIN&&t.y<Y_MAX)dot(t,1.5);
    });
  });
  mapData.players.forEach(p=>{
    if(!visP[p.id])return;
    ctx.fillStyle=colP[p.id];
    p.towns.forEach(t=>{
      if(t.x>=X_MIN&&t.x<X_MAX&&t.y>=Y_MIN&&t.y<Y_MAX)dot(t,1.95);
    });
  });

  /* grille mers */
  ctx.strokeStyle='rgba(255,255,255,0.2)';ctx.lineWidth=1;
  for(let i=1;i<VIEW;i++){
    const p=i*CELL*SCALE;
    ctx.beginPath();ctx.moveTo(p,0);ctx.lineTo(p,SIZE);ctx.stroke();
    ctx.beginPath();ctx.moveTo(0,p);ctx.lineTo(SIZE,p);ctx.stroke();
  }
  ctx.fillStyle='rgba(255,255,255,0.25)';
  ctx.font='14px sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
  for(let r=0;r<VIEW;r++)for(let c=0;c<VIEW;c++)
    ctx.fillText(`${BX+c}${BY+r}`,(c*CELL+50)*SCALE,(r*CELL+50)*SCALE);

  /* cercle 60 % */
  ctx.strokeStyle='rgba(0,0,0,0.7)';ctx.lineWidth=2;
  ctx.beginPath();ctx.arc(SIZE/2,SIZE/2,SIZE*0.31,0,Math.PI*2);ctx.stroke();

  /* temples */
  drawTemples();
}
</script>
</body>
</html>
