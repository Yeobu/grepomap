<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Carte – fr176 (mers 22 → 77)</title>
<style>
/* ───────── Mise en page générale ───────── */
body{margin:0;background:#111;color:#ccc;font-family:sans-serif;
     display:flex;flex-direction:column;align-items:center}
#topbar{margin-top:12px;display:flex;gap:24px;flex-wrap:wrap;align-items:center}
.bar{display:flex;align-items:center;gap:6px}
.groupBar{display:flex;align-items:center;gap:14px}
select,button{padding:4px;font-size:14px}
input[type=color]{border:none;width:22px;height:22px;padding:0}

/* masque le toggle Contest (classe ajoutée ci-dessous) */
.hidden{display:none!important}

/* ───────── Zone carte ───────── */
#mapWrapper{position:relative;margin-top:12px}
canvas{border:2px solid #444}

/* ───────── Légende alliances/joueurs ───────── */
#legend{position:fixed;top:60px;left:10px;
        display:flex;flex-direction:column;gap:4px;font-size:14px;z-index:5}
.row{display:flex;align-items:center;gap:4px}
.row input[type=checkbox]{margin:0}

/* ───────── Panneau temples ───────── */
#templePanel{
  position:fixed;top:88px;right:10px;width:200px;
  display:flex;flex-direction:column;gap:8px;font-size:14px;z-index:5}
#templeSearch{width:100%;padding:4px;background:#222;border:1px solid #555;
              color:#eee;border-radius:4px}
.tplRow{display:flex;align-items:center;gap:6px}

/* ───────── Contrôle taille villes ───────── */
#sizeControl{
  position:fixed;right:10px;bottom:10px;z-index:6;
  background:#222;padding:6px 8px;border:1px solid #555;border-radius:4px;
  display:flex;align-items:center;gap:6px;font-size:14px}
#citySize{width:140px}
#cityVal{min-width:26px;text-align:right;font-variant-numeric:tabular-nums;color:#fff}

/* ───────── Tooltip ───────── */
#tooltip{
  position:fixed;pointer-events:none;z-index:999;
  max-width:220px;padding:4px 6px;border-radius:4px;
  background:#222;color:#eee;font-size:13px;
  border:1px solid #555;box-shadow:0 0 4px #000;
  display:none;white-space:pre-line}

/* ───────── Temples ───────── */
.templeIcon{position:absolute;left:0;top:0;width:24px;height:24px;
            transform:translate(-12px,-12px);pointer-events:auto}
.templeIcon::before{content:"";position:absolute;inset:0;border-radius:50%;
  transform:translate(-2px,-1px) scale(1.25);opacity:.2;z-index:0;background:transparent}
.templeIcon.secured::before{background:#00c853}
.templeIcon.tocomplete::before{background:#ffeb3b}
.templeIcon.contested::before{background:#ff1744}
.templeIcon.none::before{display:none}

/* cadre blanc – recherche */
.templeIcon.match::after{
  content:"";
  position:absolute;
  inset:0;
  border:2px solid #fff;
  box-sizing:border-box;
  transform:translate(-2px,-1px);
  pointer-events:none;
  z-index:2;          /* au-dessus du vert */
}

.templeIcon.owned{
  border-radius:50%;            /* assure la forme ronde */
  box-shadow:0 0 0 4px #00e676; /* 4 px d’anneau, extérieur et circulaire */
  transform:translate(-14px,-12px);
}

/* sprite */
.sprite,.tplSprite{width:24px;height:24px;
  background:url(https://gpfr.innogamescdn.com/images/game/autogenerated/map/general/map_general_24f9f8c.png) no-repeat}
.sprite.small,.tplSprite.small{background-position:-108px -51px}
.sprite.large,.tplSprite.large{background-position:-84px -51px}
.sprite.olympus,.tplSprite.olympus{background-position:-60px -51px}

/* filtres teinte */
.red{filter:hue-rotate(-60deg)saturate(8) brightness(1.25) contrast(1.1)}
.green{filter:hue-rotate(90deg)saturate(4)}
.blue{filter:hue-rotate(200deg)saturate(4)}
.yellow{filter:hue-rotate(-30deg)saturate(5)brightness(1.2)}
.violet{filter:hue-rotate(260deg)saturate(4)}
.black{filter:brightness(0) saturate(0)}
.white{filter:brightness(3) saturate(0)}
</style>
</head>
<body>

<!-- ───────── Barre de contrôle ───────── -->
<div id="topbar">
  <div class="bar">Joueur : <select id="playerSel"></select><button id="addPlayer">＋</button></div>
  <div class="bar">Alliance : <select id="allySel"></select><button id="addAlly">＋</button></div>

  <div class="groupBar">
    <label><input type="checkbox" id="chkMolky"> Molky</label>
    <label><input type="checkbox" id="chkAllies"> Alliés</label>
    <label><input type="checkbox" id="chkCafe"> Café clopes</label>

    <!-- Toggle « Contest » masqué temporairement -->
    <label class="hidden"><input type="checkbox" id="chkContest"> Contest</label>

    <label><input type="checkbox" id="chkColor" checked> Colorer temples</label>
    <label><input type="checkbox" id="chkFocus" checked> Nos temples</label>
  </div>
</div>

<div id="legend"></div>

<!-- Panneau temples -->
<div id="templePanel">
  <input id="templeSearch" placeholder="Rechercher nom, type ou bonus…">
  <div id="templeLegend"></div>
</div>

<!-- Carte + tooltip -->
<div id="mapWrapper"><canvas id="map" width="800" height="800"></canvas></div>
<div id="tooltip"></div>

<!-- Slider taille villes -->
<div id="sizeControl">
  Taille villes :
  <input type="range" id="citySize" min="0" max="100" value="0">
  <span id="cityVal">2</span>
</div>

<script src="mapData.js"></script>
<script>
/* ─── Constantes et données ─── */
const VIEW=6,CELL=100,SIZE=800,SCALE=SIZE/(VIEW*CELL);
const BX=2,BY=2,X_MIN=BX*CELL,Y_MIN=BY*CELL,X_MAX=X_MIN+VIEW*CELL,Y_MAX=Y_MIN+VIEW*CELL;
const GROUPS={molky:{ids:[186,368],color:'#ff0000'},
              allies:{ids:[335,19,239,595,594],color:'#00CCFF'},
              cafe:{ids:[3,350],color:'#ff8c00'}};
const COLOR_BY_TYPE={'OFF T':'yellow','OFF NAV':'red','PROD T':'green','PROD NAV':'blue',
                     '3% OFF':'violet','Portail':'white','DEF':'black'};
const palette=['#00ffff','#ff7f00','#00ff00','#ff00ff','#ffff00','#00bfff',
               '#ff1493','#7fff00','#ff4500','#20b2aa'];
let palIdx=0,cityRadius=2,minR=2,maxR=8;
const visA={},colA={},visP={},colP={};

/* DOM refs */
const mapWrapper=document.getElementById('mapWrapper');
const canvas=document.getElementById('map'),ctx=canvas.getContext('2d');
const playerSel=document.getElementById('playerSel'),addPlayer=document.getElementById('addPlayer');
const allySel=document.getElementById('allySel'),addAlly=document.getElementById('addAlly');
const legend=document.getElementById('legend');
const templeLegend=document.getElementById('templeLegend');
const searchInput=document.getElementById('templeSearch');
const tooltip=document.getElementById('tooltip');
const chkMolky=document.getElementById('chkMolky');
const chkAllies=document.getElementById('chkAllies');
const chkCafe=document.getElementById('chkCafe');
const chkContest=document.getElementById('chkContest');
const chkColor=document.getElementById('chkColor');
const chkFocus=document.getElementById('chkFocus');
const citySize=document.getElementById('citySize');
const cityVal=document.getElementById('cityVal');

/* Slider taille villes */
citySize.oninput=()=>{
  const pct=citySize.value/100;
  cityRadius=minR+(maxR-minR)*pct;
  cityVal.textContent=cityRadius.toFixed(0);
  draw();
};
cityVal.textContent=minR;

/* Listes déroulantes */
mapData.players.slice().sort((a,b)=>a.name.localeCompare(b.name,'fr'))
  .forEach(p=>playerSel.add(new Option(p.name,p.id)));
mapData.alliances.slice().sort((a,b)=>a.name.localeCompare(b.name,'fr'))
  .forEach(a=>allySel.add(new Option(a.name,a.id)));

/* Légende types temples */
Object.entries(COLOR_BY_TYPE).forEach(([type,col])=>{
  const row=document.createElement('div');
  row.className='tplRow';
  row.innerHTML=`<div class="tplSprite small ${col}"></div><span>${type}</span>`;
  templeLegend.append(row);
});

/* Légende alliances/joueurs */
function addRow(id,label,color,vis,col){
  if(vis[id])return;
  vis[id]=true;col[id]=color;
  const row=document.createElement('div');row.className='row';row.dataset.aid=id;
  row.innerHTML=`<input type="checkbox" checked>
                 <input type="color" value="${color}">
                 ${label}`;
  const [cb,cp]=row.querySelectorAll('input');
  cb.onchange=()=>{vis[id]=cb.checked;draw();};
  cp.oninput =()=>{col[id]=cp.value;draw();};
  legend.append(row);
}
function removeRow(id,vis){
  const row=legend.querySelector(`.row[data-aid="${id}"]`);
  if(row)legend.removeChild(row);
  delete vis[id];
}

/* Boutons + */
addPlayer.onclick=()=>{
  const p=mapData.players.find(x=>x.id==playerSel.value);
  if(p) addRow(p.id,p.name,palette[palIdx++%palette.length],visP,colP),draw();
};
addAlly.onclick=()=>{
  const a=mapData.alliances.find(x=>x.id==allySel.value);
  if(a) addRow(a.id,a.name,palette[palIdx++%palette.length],visA,colA),draw();
};

/* Groupes fixes */
function toggleGroup(box,g){
  g.ids.forEach(id=>{
    box.checked ? addRow(id,mapData.alliances.find(a=>a.id==id)?.name||`Alliance ${id}`,
                         g.color,visA,colA)
                : removeRow(id,visA);
  });
  draw();
}
chkMolky.onchange  =()=>toggleGroup(chkMolky ,GROUPS.molky );
chkAllies.onchange =()=>toggleGroup(chkAllies,GROUPS.allies);
chkCafe.onchange   =()=>toggleGroup(chkCafe  ,GROUPS.cafe  );
[chkContest,chkColor,chkFocus].forEach(el=>el.onchange=draw);

/* Recherche */
searchInput.addEventListener('input',applyHighlight);
function applyHighlight(){
  const term=searchInput.value.trim().toLowerCase();
  document.querySelectorAll('.templeIcon').forEach(el=>{
    const hit = term && ( el.dataset.name.includes(term) ||
                          el.dataset.tmpltype.includes(term) ||
                          el.dataset.bonus.includes(term) );
    el.classList.toggle('match',hit);
  });
}

/* Tooltip */
function showTip(txt,x,y){
  tooltip.textContent=txt;
  tooltip.style.left=`${x+12}px`;
  tooltip.style.top =`${y+12}px`;
  tooltip.style.display='block';
}
const hideTip=()=>tooltip.style.display='none';

/* Offsets points */
const OFF=[[0,0],[1,0],[-1,0],[0,1],[0,-1],[1,1],[-1,1],[1,-1],[-1,-1],
           [2,0],[-2,0],[0,2],[0,-2],[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[-1,2],[1,-2]];
const toPx=(c,o)=>(c-o)*SCALE;
function dot(t){
  const d=OFF[t.slot%20]||[0,0];
  const x=toPx(t.x+d[0],X_MIN),y=toPx(t.y+d[1],Y_MIN);
  ctx.beginPath();ctx.arc(x,y,cityRadius,0,Math.PI*2);ctx.fill();
  ctx.lineWidth=.5;ctx.strokeStyle='#000';ctx.stroke();
}

/* Temples */
function drawTemples(){
  mapWrapper.querySelectorAll('.templeIcon').forEach(e=>e.remove());
  const showContest=chkContest.checked;
  const showColor  =chkColor.checked;
  const onlyFocus  =chkFocus.checked;

  mapData.temples.forEach(t=>{
    if(t.x<X_MIN||t.x>=X_MAX||t.y<Y_MIN||t.y>=Y_MAX) return;
    const isFocus = t.focus===true || String(t.focus).toLowerCase()==='true';
    if(onlyFocus && !isFocus) return;

    const status=(showContest&&t.contest&&t.contest!=='none')?t.contest:'none';

    const box=document.createElement('div');
    box.className=`templeIcon ${status}`.trim();
    box.style.left=`${toPx(t.x,X_MIN)}px`;
    box.style.top =`${toPx(t.y,Y_MIN)}px`;
    box.dataset.name    =(t.name||'').toLowerCase();
    box.dataset.tmpltype=(t.type||'').toLowerCase();
    box.dataset.bonus   =(t.bonus||'').toLowerCase();

    box.onmouseenter=e=>showTip(`${t.name}\n${t.bonus}`,e.clientX,e.clientY);
    box.onmousemove =e=>{tooltip.style.left=`${e.clientX+12}px`;
                          tooltip.style.top =`${e.clientY+12}px`;};
    box.onmouseleave=hideTip;

    /* cadre vert si temple conquis et case « Nos temples » cochée */
    const isConq = t.conquest === true || String(t.conquest).toLowerCase() === 'true';
    if (chkFocus.checked && isConq){
      box.classList.add('owned');
    }

    const sp=document.createElement('div');
    sp.className=`sprite ${t.size||'small'}`;
    const c=COLOR_BY_TYPE[t.type];
    if(showColor&&c) sp.classList.add(c);
    box.append(sp);
    mapWrapper.append(box);
  });
  applyHighlight();
}

/* Fond mer */
const water=new Image();
water.src='assets/water_base.png';
water.onload=draw;
water.onerror=draw;

/* Rendu principal */
function draw(){
  ctx.fillStyle=water.complete&&water.naturalWidth?
    ctx.createPattern(water,'repeat'):'#0a4c82';
  ctx.fillRect(0,0,SIZE,SIZE);

  /* Villes alliances */
  mapData.alliances.forEach(a=>{
    if(!visA[a.id])return;
    ctx.fillStyle=colA[a.id];
    a.towns.forEach(t=>{
      if(t.x>=X_MIN&&t.x<X_MAX&&t.y>=Y_MIN&&t.y<Y_MAX) dot(t);
    });
  });

  /* Villes joueurs */
  mapData.players.forEach(p=>{
    if(!visP[p.id])return;
    ctx.fillStyle=colP[p.id];
    p.towns.forEach(t=>{
      if(t.x>=X_MIN&&t.x<X_MAX&&t.y>=Y_MIN&&t.y<Y_MAX) dot(t);
    });
  });

  /* Grille mers + numéros */
  ctx.strokeStyle='rgba(255,255,255,0.2)';ctx.lineWidth=1;
  for(let i=1;i<VIEW;i++){
    const p=i*CELL*SCALE;
    ctx.beginPath();ctx.moveTo(p,0);ctx.lineTo(p,SIZE);ctx.stroke();
    ctx.beginPath();ctx.moveTo(0,p);ctx.lineTo(SIZE,p);ctx.stroke();
  }
  ctx.fillStyle='rgba(255,255,255,0.25)';
  ctx.font='14px sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
  for(let r=0;r<VIEW;r++)
    for(let c=0;c<VIEW;c++)
      ctx.fillText(`${BX+c}${BY+r}`,(c*CELL+50)*SCALE,(r*CELL+50)*SCALE);

  /* Cercle 60 % */
  ctx.strokeStyle='rgba(0,0,0,0.7)';ctx.lineWidth=2;
  ctx.beginPath();ctx.arc(SIZE/2,SIZE/2,SIZE*0.31,0,Math.PI*2);ctx.stroke();

  drawTemples();
}

/* Premier rendu */
draw();
</script>
</body>
</html>
